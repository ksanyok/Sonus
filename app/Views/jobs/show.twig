{% extends "layouts/base.twig" %}

{% block title %}–û—Ç—á—ë—Ç #{{ job.id|slice(0, 8) }} - Call Audit Proto{% endblock %}

{% block content %}
<div x-data="jobReport()" x-init="init('{{ job.status }}')">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-gray-900">
                –û—Ç—á—ë—Ç #{{ job.id|slice(0, 8) }}
            </h2>
            <span 
                class="px-3 py-1 rounded-full text-sm font-medium"
                :class="{
                    'bg-yellow-100 text-yellow-800': '{{ job.status }}' !== 'done',
                    'bg-green-100 text-green-800': '{{ job.status }}' === 'done'
                }"
            >
                {{ job.status }}
            </span>
        </div>

        <!-- Progress Bar -->
        {% if job.status != 'done' %}
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" :style="'width: ' + progress + '%'"></div>
        </div>
        <p class="text-sm text-gray-600 text-center" x-text="statusText"></p>
        {% endif %}

        {% if report %}
        <!-- Participants Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <div>
                        <div class="text-xs text-blue-600 font-medium">–û–ø–µ—Ä–∞—Ç–æ—Ä</div>
                        <div class="text-sm font-bold text-blue-900">{{ report.json.call_meta.agent_name|default('–ù–µ —É–∫–∞–∑–∞–Ω–æ') }}</div>
                    </div>
                </div>
            </div>
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <div>
                        <div class="text-xs text-green-600 font-medium">–ö–ª–∏–µ–Ω—Ç</div>
                        <div class="text-sm font-bold text-green-900">{{ report.json.call_meta.client_name|default('–ù–µ —É–∫–∞–∑–∞–Ω–æ') }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
            <div class="bg-blue-50 rounded-lg p-4">
                <div class="text-sm text-blue-600 font-medium">–§–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–ª</div>
                <div class="text-2xl font-bold text-blue-900">{{ report.final_score|number_format(1) }}</div>
            </div>
            <div class="bg-green-50 rounded-lg p-4">
                <div class="text-sm text-green-600 font-medium">–û–±–æ–≤'—è–∑–∫–æ–≤—ñ</div>
                <div class="text-2xl font-bold text-green-900">{{ report.mandatory_avg|number_format(1) }}</div>
            </div>
            <div class="bg-purple-50 rounded-lg p-4">
                <div class="text-sm text-purple-600 font-medium">–ó–∞–≥–∞–ª—å–Ω—ñ</div>
                <div class="text-2xl font-bold text-purple-900">{{ report.general_avg|number_format(1) }}</div>
            </div>
            <div class="bg-{{ report.ethics_flag ? 'red' : 'gray' }}-50 rounded-lg p-4">
                <div class="text-sm text-{{ report.ethics_flag ? 'red' : 'gray' }}-600 font-medium">–ï—Ç–∏–∫–∞</div>
                <div class="text-2xl font-bold text-{{ report.ethics_flag ? 'red' : 'gray' }}-900">
                    {{ report.ethics_flag ? '‚ö†Ô∏è –ü–æ—Ä—É—à–µ–Ω–Ω—è' : '‚úÖ OK' }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% if report %}
    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <button 
                    @click="activeTab = 'criteria'" 
                    :class="activeTab === 'criteria' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                >
                    –ö—Ä–∏—Ç–µ—Ä–∏–∏
                </button>
                <button 
                    @click="activeTab = 'triggers'" 
                    :class="activeTab === 'triggers' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                >
                    –¢—Ä–∏–≥–≥–µ—Ä—ã
                </button>
                <button 
                    @click="activeTab = 'diagnostics'" 
                    :class="activeTab === 'diagnostics' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                >
                    –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                </button>
                <button 
                    @click="activeTab = 'export'" 
                    :class="activeTab === 'export' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                >
                    –≠–∫—Å–ø–æ—Ä—Ç
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- Criteria Tab -->
            <div x-show="activeTab === 'criteria'" x-cloak>
                {% include 'partials/report-block.twig' with {'title': '–û–±–æ–≤\'—è–∑–∫–æ–≤—ñ –∫—Ä–∏—Ç–µ—Ä—ñ—ó', 'items': report.json.blocks.mandatory, 'badge': 'blue'} %}
                {% include 'partials/report-block.twig' with {'title': '–ó–∞–≥–∞–ª—å–Ω—ñ –∫—Ä–∏—Ç–µ—Ä—ñ—ó', 'items': report.json.blocks.general, 'badge': 'purple'} %}
                {% include 'partials/report-block.twig' with {'title': '–ï—Ç–∏–∫–∞', 'items': report.json.blocks.ethics, 'badge': 'red'} %}
            </div>

            <!-- Triggers Tab -->
            <div x-show="activeTab === 'triggers'" x-cloak>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">–°–ª—É—á–∞–∏ –≥—Ä—É–±–æ—Å—Ç–∏, –º–∞—Ç–∞ –∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π</h3>
                
                {% if report.json.triggers.lexicon_hits|length > 0 %}
                <div class="overflow-x-auto mb-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–∏–ø</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ß—Ç–æ —Å–∫–∞–∑–∞–Ω–æ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ö–æ–Ω—Ç–µ–∫—Å—Ç</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°–µ–∫—É–Ω–¥–∞</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ö—Ç–æ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for trigger in report.json.triggers.lexicon_hits %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 font-medium">
                                        {{ trigger.type }}
                                    </span>
                                </td>
                                <td class="px-4 py-4">
                                    <span class="text-sm font-bold text-red-600">"{{ trigger.term }}"</span>
                                </td>
                                <td class="px-4 py-4 text-sm text-gray-700 max-w-md">
                                    <div class="italic">{{ trigger.context|default('‚Äî') }}</div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="text-sm font-mono text-blue-600">{{ trigger.t|number_format(1) }}s</span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded-full {{ trigger.speaker == 'agent' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800' }}">
                                        {{ trigger.speaker == 'agent' ? '–û–ø–µ—Ä–∞—Ç–æ—Ä' : '–ö–ª–∏–µ–Ω—Ç' }}
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    {% set severity = trigger.severity|default('medium') %}
                                    <span class="px-2 py-1 text-xs rounded-full font-medium
                                        {{ severity == 'high' ? 'bg-red-500 text-white' : '' }}
                                        {{ severity == 'medium' ? 'bg-orange-100 text-orange-800' : '' }}
                                        {{ severity == 'low' ? 'bg-yellow-100 text-yellow-800' : '' }}">
                                        {{ severity == 'high' ? 'üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ' : '' }}
                                        {{ severity == 'medium' ? 'üü† –°—Ä–µ–¥–Ω–µ' : '' }}
                                        {{ severity == 'low' ? 'üü° –õ–µ–≥–∫–æ' : '' }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                    <svg class="w-12 h-12 text-green-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-green-700 font-medium">–°–ª—É—á–∞–µ–≤ –≥—Ä—É–±–æ—Å—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</p>
                </div>
                {% endif %}

                <h3 class="text-lg font-semibold text-gray-900 mb-4 mt-8">–ê—É–¥–∏–æ-—Å–æ–±—ã—Ç–∏—è</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–∏–ø</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ü–µ—Ä–∏–æ–¥</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°–ø–∏–∫–µ—Ä</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–µ—Ç–∞–ª–∏</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for event in report.json.triggers.audio_events %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800">{{ event.type }}</span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500">{{ event.t_start|number_format(1) }}s - {{ event.t_end|number_format(1) }}s</td>
                                <td class="px-6 py-4 text-sm text-gray-500">{{ event.speaker }}</td>
                                <td class="px-6 py-4 text-sm text-gray-500">
                                    {% if event.delta_db %}Œî{{ event.delta_db|number_format(1) }}dB{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Diagnostics Tab -->
            <div x-show="activeTab === 'diagnostics'" x-cloak>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 font-medium mb-1">LUFS (–≥—Ä–æ–º–∫–æ—Å—Ç—å)</div>
                        <div class="text-xl font-bold text-gray-900">{{ report.json.diagnostics.audio_lufs|number_format(1) }} dB</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 font-medium mb-1">–î–æ–ª—è —Ä–µ—á–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</div>
                        <div class="text-xl font-bold text-gray-900">{{ (report.json.diagnostics.agent_talk_ratio * 100)|number_format(0) }}%</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 font-medium mb-1">–ü–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è</div>
                        <div class="text-xl font-bold text-gray-900">{{ (report.json.diagnostics.overlap_ratio * 100)|number_format(0) }}%</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 font-medium mb-1">–°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞</div>
                        <div class="text-xl font-bold text-gray-900">{{ report.json.diagnostics.avg_response_latency_sec|number_format(1) }}s</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 font-medium mb-1">–¢–æ—á–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏</div>
                        <div class="text-xl font-bold text-gray-900">{{ (report.json.diagnostics.transcript_confidence * 100)|number_format(0) }}%</div>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div x-show="activeTab === 'export'" x-cloak>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <a href="/export/{{ report.id }}.json" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <span class="font-medium text-gray-900">JSON</span>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </a>
                    <a href="/export/{{ report.id }}.csv" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <span class="font-medium text-gray-900">CSV</span>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </a>
                    <a href="/export/{{ report.id }}.xlsx" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <span class="font-medium text-gray-900">Excel (XLSX)</span>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </a>
                    <a href="/export/{{ report.id }}.pdf" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <span class="font-medium text-gray-900">PDF</span>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function jobReport() {
    return {
        activeTab: 'criteria',
        progress: 0,
        statusText: '',
        
        init(status) {
            this.updateProgress(status);
        },
        
        updateProgress(status) {
            const stages = {
                'uploaded': { progress: 10, text: '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω' },
                'transcribing': { progress: 25, text: '–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –∞—É–¥–∏–æ...' },
                'analyzing_metrics': { progress: 40, text: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ-–º–µ—Ç—Ä–∏–∫–∏...' },
                'detecting_triggers': { progress: 60, text: '–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã...' },
                'building_rubric': { progress: 70, text: '–°—Ç—Ä–æ–∏–º —Ä—É–±—Ä–∏–∫—É...' },
                'scoring': { progress: 85, text: '–û—Ü–µ–Ω–∏–≤–∞–µ–º –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º...' },
                'assembling': { progress: 95, text: '–°–æ–±–∏—Ä–∞–µ–º –æ—Ç—á—ë—Ç...' },
                'done': { progress: 100, text: '–ì–æ—Ç–æ–≤–æ!' }
            };
            
            const stage = stages[status] || { progress: 0, text: status };
            this.progress = stage.progress;
            this.statusText = stage.text;
        }
    }
}
</script>
{% endblock %}
